<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Washing Machine Start Time - Prioritized & Explained</title>
<link rel="icon" type="image/png" sizes="192x192" href="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f9fc.png" />
<meta name="theme-color" content="#eaf6ff" />
<style>
  body { font-family: sans-serif; margin: 1em; background: #f9f9f9; }
  .container { max-width: 470px; margin: auto; background: #fff; padding: 2em; border-radius: 12px; box-shadow: 0 2px 8px #0001; }
  label { display: block; margin-top: 1em; font-weight: 500; }
  .time-input { display: flex; gap: 0.5em; align-items: center; margin-bottom: 1em; }
  .digit-control { display: flex; flex-direction: column; align-items: center; width: 2.5em; }
  button.digit-btn { width: 2.5em; height: 2em; font-size: 1.2em; cursor: pointer; user-select: none; background: #eaf6ff; border: none; border-radius: 4px; }
  button.digit-btn:active { background: #b3e0ff; }
  input.digit { width: 2.5em; font-size: 1.5em; text-align: center; border: 1px solid #ccc; border-radius: 4px; background: #fff; }
  input.number-input { width: 3em; font-size: 1.2em; text-align: center; border: 1px solid #ccc; border-radius: 4px; background: #fff; }
  .colon { font-size: 1.5em; line-height: 2.5em; user-select: none; }
  #result { margin-top: 2em; padding: 1em; background: #eaf6ff; border-radius: 8px; font-size: 1.15em; white-space: pre-wrap; }
  .inputs-group { margin-bottom: 1.5em; }
  .button-row { display: flex; gap: 0.7em; align-items: center; margin-top: 1em; flex-wrap: wrap; }
  .main-btn { display: flex; align-items: center; gap: 0.4em; font-size: 1em; border-radius: 6px; padding: 0.5em 1em; border: none; cursor: pointer; white-space: nowrap; }
  #calcBtn { background: #3498db; color: #fff; }
  #calcBtn:active { background: #217dbb; }
  #predictBtn { background: #28a745; color: white; }
  #predictBtn:active { background: #1e7e34; }
  #resetBtn { background: #ccc; color: #222; }
  #resetBtn:active { background: #aaa; }
  .icon-wash { width: 32px; height: 32px; vertical-align: middle; margin-right: 0.5em; }
  #pv-cycles-list { font-size: 0; }
  .pv-btn {
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    box-sizing: border-box;
    text-align: left;
    min-height: 48px;
    margin: 0.36em 0;
    padding: 0.6em 1.2em 0.6em 1.1em;
    border: none;
    border-radius: 12px;
    font-weight: 500;
    background: linear-gradient(90deg, #ffd6de 70%, #ffbcd3 100%);
    color: #a15772;
    box-shadow: 0 2px 6px #ffbcd321;
    cursor: pointer;
    transition: background 0.2s, box-shadow 0.2s;
    position: relative;
    line-height: 1.1;
  }
  .pv-btn:active, .pv-btn.open { background: linear-gradient(90deg, #ffe2e9 70%, #ffd6de 100%); box-shadow: 0 4px 12px #ffbcd340; }
  .pv-chevron {
    display: inline-flex;
    align-items: center;
    margin-left: 1em;
    width: 22px;
    height: 22px;
    transition: transform 0.27s ease;
  }
  .pv-btn.open .pv-chevron { transform: rotate(180deg); }
  .pv-chevron svg { display: block; margin: 0; line-height: 1; width: 22px; height: 22px; }
  .pv-breakdown-container {
    margin-top: 2px;
    margin-bottom: 14px;
    padding: 12px 16px;
    background: #ffe6eb;
    border-radius: 10px;
    box-shadow: inset 0 0 8px #fcb6bfaa;
    font-size: 1rem;
  }
  @media (max-width: 500px) {
    .container { padding: 1em; }
    .icon-wash { width: 24px; height: 24px; }
    .button-row { justify-content: center; }
  }
</style>
</head>
<body>
<script>
window.onerror = function(msg, src, line, col, err) {
  console.error('Global error caught:', msg, src, line, col, err);
  alert(`Error: ${msg} at ${src}:${line}:${col}`);
};

function pad(n) { return n.toString().padStart(2, '0'); }
function setHourDigits(prefix, hour) {
  document.getElementById(prefix + 'HourTens').value = String(Math.floor(hour / 10));
  document.getElementById(prefix + 'HourOnes').value = String(hour % 10);
}
function setMinuteDigits(prefix, minute) {
  document.getElementById(prefix + 'MinuteTens').value = String(Math.floor(minute / 10));
  document.getElementById(prefix + 'MinuteOnes').value = String(minute % 10);
}
function getTimeFromDigits(prefix) {
  const hour = parseInt(document.getElementById(prefix + 'HourTens').value, 10) * 10 +
               parseInt(document.getElementById(prefix + 'HourOnes').value, 10);
  const minute = parseInt(document.getElementById(prefix + 'MinuteTens').value, 10) * 10 +
                 parseInt(document.getElementById(prefix + 'MinuteOnes').value, 10);
  return [hour, minute];
}
function setDefaults() {
  const now = new Date();
  let h = now.getHours();
  let m = now.getMinutes();
  let finishHour = m === 0 ? h : h + 1;
  finishHour = (finishHour + 3) % 24;
  setHourDigits('finish', finishHour);
  setMinuteDigits('finish', 0);
  setHourDigits('duration', 2);
  setMinuteDigits('duration', 39);
}
function changeHour(prefix, delta) {
  let [hour, ] = getTimeFromDigits(prefix);
  hour = (hour + delta + 24) % 24;
  setHourDigits(prefix, hour);
  calculateStartTime();
}
function changeMinute(prefix, delta) {
  let [, minute] = getTimeFromDigits(prefix);
  minute = (minute + delta + 60) % 60;
  setMinuteDigits(prefix, minute);
  calculateStartTime();
}
function digitInputHandler(e, prefix, type) {
  let tensId = prefix + (type === 'hour' ? 'HourTens' : 'MinuteTens');
  let onesId = prefix + (type === 'hour' ? 'HourOnes' : 'MinuteOnes');
  let tens = parseInt(document.getElementById(tensId).value, 10);
  if (isNaN(tens)) tens = 0;
  let ones = parseInt(document.getElementById(onesId).value, 10);
  if (isNaN(ones)) ones = 0;
  let value = tens * 10 + ones;
  if (type === 'hour') {
    if (value > 23) value = 23;
    if (value < 0) value = 0;
    setHourDigits(prefix, value);
  } else {
    if (value > 59) value = 59;
    if (value < 0) value = 0;
    setMinuteDigits(prefix, value);
  }
  calculateStartTime();
}
function toggleSolarUsage() {
  const solarUsed = document.getElementById('solarToggle').checked;
  document.getElementById('finishTimeGroup').style.display = solarUsed ? 'none' : 'block';
  document.getElementById('cyclesInput').style.display = solarUsed ? 'block' : 'none';
  Array.from(document.querySelectorAll('#finishTimeGroup input,#finishTimeGroup button')).forEach(el => el.disabled = solarUsed);
  if(solarUsed){
    document.getElementById('numCycles').value = '1';
  }
  calculateStartTime();
}
function changeCycle(delta) {
  const el = document.getElementById('numCycles');
  let val = parseInt(el.value, 10);
  if (isNaN(val)) val = 1;
  val += delta;
  if (val < 1) val = 1;
  if (val > 10) val = 10;
  el.value = val.toString();
}
function digitCycleHandler(e) {
  let val = parseInt(e.target.value, 10);
  if (isNaN(val) || val < 1) {
    val = 1;
  } else if (val > 10) {
    val = 10;
  }
  e.target.value = val.toString();
}
function displayResult(startDate, now, durationMins) {
  const timerSettings = [];
  for (let h = 0; h <= 10; h++) {
    if (h > 0) timerSettings.push(h * 60);
    if (h < 10) timerSettings.push(h * 60 + 30);
  }
  for (let h = 11; h <= 24; h++) {
    timerSettings.push(h * 60);
  }
  let startHour = startDate.getHours().toString().padStart(2, '0');
  let startMinute = startDate.getMinutes().toString().padStart(2, '0');
  let diffMs = startDate.getTime() - now.getTime();
  let diffMins = Math.round(diffMs / (1000 * 60));
  let diffHours = Math.floor(diffMins / 60);
  let diffMinutes = diffMins % 60;
  let exactStartIn = `${diffHours} hour(s) and ${diffMinutes} minute(s) from now`;
  let roundedDownSetting = null;
  for (let i = timerSettings.length - 1; i >= 0; i--) {
    if (timerSettings[i] <= diffMins) {
      roundedDownSetting = timerSettings[i];
      break;
    }
  }
  let roundedDownStr = roundedDownSetting !== null ?
    `${Math.floor(roundedDownSetting / 60)}:${pad(roundedDownSetting % 60)}` : "No suitable timer setting";
  document.getElementById('result').innerHTML =
    `<div>Closest round down timer setting:</div>` +
    `<h2>${roundedDownStr}</h2>` +
    `<div><strong>Start the washing machine at:</strong> ${startHour}:${startMinute}</div>` +
    `<div><strong>Actual start in:</strong> ${exactStartIn}</div>`;
}
function calculateStartTime() {
  const solarUsed = document.getElementById('solarToggle').checked;
  const resultDiv = document.getElementById('result');
  resultDiv.innerHTML = "";
  const [durHour, durMinute] = getTimeFromDigits('duration');
  if (durHour > 23 || durMinute > 59) return resultDiv.innerHTML = "Please enter a valid duration.";
  const durationMins = durHour * 60 + durMinute;
  const now = new Date();
  if (!solarUsed) {
    const [finishHour, finishMinute] = getTimeFromDigits('finish');
    if (finishHour > 23 || finishMinute > 59) return resultDiv.innerHTML = "Please enter a valid finish time.";
    let finishDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), finishHour, finishMinute);
    if (finishDate <= now) finishDate.setDate(finishDate.getDate() + 1);
    let startDate = new Date(finishDate.getTime() - durationMins * 60 * 1000);
    while (startDate <= now) {
      startDate = new Date(startDate.getTime() + 24 * 60 * 60 * 1000);
    }
    displayResult(startDate, now, durationMins);
  } else {
    resultDiv.innerHTML = "Solar prediction is active. Use the ðŸ”† Predict Best Start Times button.";
  }
}
function interpolatePVAt(timeMs, forecastData) {
  let before = null, after = null;
  for (let i = 0; i < forecastData.length - 1; i++) {
    const t0 = forecastData[i].time.getTime();
    const t1 = forecastData[i + 1].time.getTime();
    if (t0 <= timeMs && t1 >= timeMs) {
      before = forecastData[i];
      after = forecastData[i + 1];
      break;
    }
  }
  if (!before || !after) {
    if (before) return before.pvEstimate;
    if (after) return after.pvEstimate;
    return 0;
  }
  const dt = after.time.getTime() - before.time.getTime();
  const dpv = after.pvEstimate - before.pvEstimate;
  const fraction = (timeMs - before.time.getTime()) / dt;
  return before.pvEstimate + dpv * fraction;
}
function getPVEnergyContributions(startTime, durationMinutes, forecastData) {
  const durationMs = durationMinutes * 60 * 1000;
  const startTs = startTime.getTime();
  const endTs = startTs + durationMs;
  const times = [startTs];
  forecastData.forEach(({ time }) => {
    const t = time.getTime();
    if (t > startTs && t < endTs) times.push(t);
  });
  times.push(endTs);
  const energySlices = [];
  for (let i = 0; i < times.length - 1; i++) {
    const tA = times[i], tB = times[i + 1];
    const pvA = interpolatePVAt(tA, forecastData);
    const pvB = interpolatePVAt(tB, forecastData);
    const avgPV = (pvA + pvB) / 2;
    const duration = tB - tA;
    energySlices.push({
      start: new Date(tA),
      end: new Date(tB),
      durationMs: duration,
      avgPV,
      kWh: avgPV * duration / (1000 * 60 * 60),
      isStart: i === 0,
      isEnd: i === times.length - 2
    });
  }
  return energySlices;
}
function createPVContributionsChart(startTime, durationMinutes, forecastData) {
  const slices = getPVEnergyContributions(startTime, durationMinutes, forecastData);
  const maxPV = Math.max(...slices.map(d => d.avgPV), 1);
  const pxPerMs = 38 / (60 * 60 * 1000);
  const barGap = 3; // pixel gap between bars
  const minWidth = 9; // minimum bar width
  const chartWidth = Math.max(320, slices.reduce((sum, d) => sum + Math.max(minWidth, d.durationMs * pxPerMs), 38) + (slices.length - 1) * barGap + 40);
  const chartHeight = 120;
  let svg = `<svg width="${chartWidth}" height="${chartHeight}" style="display:block;margin:auto;background:#fff;border-radius:8px;">`;
  let xCursor = 36;
  slices.forEach((d, i) => {
    const barWidthRaw = Math.max(minWidth, d.durationMs * pxPerMs);
    const barWidth = barWidthRaw;
    const barHeight = (d.avgPV / maxPV) * (chartHeight - 56);
    const y = chartHeight - barHeight - 50;
    const fill = d.isStart || d.isEnd ? "#fff4c2" : "#ffd6de";
    const labelTxt = d.isStart ? "Start (interp)" : d.isEnd ? "End (interp)" : "";
    if (labelTxt) svg += `<text x="${xCursor + barWidth / 2}" y="${y - 11}" text-anchor="middle" font-size="11" fill="#caad42">${labelTxt}</text>`;
    svg += `
      <rect x="${xCursor}" y="${y}" width="${barWidth}" height="${barHeight}" fill="${fill}" stroke="#a15772">
      <title>${d.kWh.toFixed(3)} kWh (${d.avgPV.toFixed(2)} kW Ã— ${Math.round(d.durationMs / 60000)}min)</title>
      </rect>
      <text x="${xCursor + barWidth / 2}" y="${chartHeight - 21}" text-anchor="middle" font-size="11" fill="#a15772">
        ${pad(d.start.getHours())}:${pad(d.start.getMinutes())}
      </text>
      <text x="${xCursor + barWidth / 2}" y="${y - 4}" text-anchor="middle" font-size="11" fill="#a15772">
        ${d.avgPV.toFixed(2)}
      </text>`;
    xCursor += barWidth + barGap;
  });
  svg += `<text x="10" y="${chartHeight / 2}" text-anchor="start" font-size="12" fill="#a15772" transform="rotate(-90 14,${chartHeight / 2})">PV (kW)</text>`;
  svg += "</svg>";
  const totalKWh = slices.reduce((sum, d) => sum + d.kWh, 0);
  svg += `<div style="margin:10px 0;text-align:center;">Total PV used in cycle: <strong>${totalKWh.toFixed(2)} kWh</strong></div>`;
  return svg;
}
// ... the rest of your previous JS and HTML remains as is 
// including fetchForecastFromSheet, predictBestStartTimesHandler, attachListeners, etc.
</script>
<div class="container" role="main">
  <h3>
    <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f9fc.png" alt="Washing Machine" class="icon-wash" />
    Washing Machine Start Time - Prioritized & Explained
  </h3>
  <form id="calcForm" autocomplete="off">
    <label><input type="checkbox" id="solarToggle" /> Use Solar Prediction</label>
    <div class="inputs-group" id="finishTimeGroup">
      <label for="finishHourTens">Desired Finish Time:</label>
      <div class="time-input" id="finishTimeInput">
        <div class="digit-control">
          <button type="button" class="digit-btn" id="finishHourUp">â–²</button>
          <input id="finishHourTens" class="digit" maxlength="1" inputmode="numeric" pattern="[0-9]*" />
          <button type="button" class="digit-btn" id="finishHourDown">â–¼</button>
        </div>
        <div class="digit-control"><input id="finishHourOnes" class="digit" maxlength="1" inputmode="numeric" pattern="[0-9]*" /></div>
        <div class="colon">:</div>
        <div class="digit-control">
          <button type="button" class="digit-btn" id="finishMinuteUp">â–²</button>
          <input id="finishMinuteTens" class="digit" maxlength="1" inputmode="numeric" pattern="[0-9]*" />
          <button type="button" class="digit-btn" id="finishMinuteDown">â–¼</button>
        </div>
        <div class="digit-control"><input id="finishMinuteOnes" class="digit" maxlength="1" inputmode="numeric" pattern="[0-9]*" /></div>
      </div>
    </div>
    <div class="inputs-group" id="durationInput">
      <label for="durationHourTens">Washing Program Duration:</label>
      <div class="time-input" id="durationTimeInput">
        <div class="digit-control">
          <button type="button" class="digit-btn" id="durationHourUp">â–²</button>
          <input id="durationHourTens" class="digit" maxlength="1" inputmode="numeric" pattern="[0-9]*" />
          <button type="button" class="digit-btn" id="durationHourDown">â–¼</button>
        </div>
        <div class="digit-control"><input id="durationHourOnes" class="digit" maxlength="1" inputmode="numeric" pattern="[0-9]*" /></div>
        <div class="colon">:</div>
        <div class="digit-control">
          <button type="button" class="digit-btn" id="durationMinuteUp">â–²</button>
          <input id="durationMinuteTens" class="digit" maxlength="1" inputmode="numeric" pattern="[0-9]*" />
          <button type="button" class="digit-btn" id="durationMinuteDown">â–¼</button>
        </div>
        <div class="digit-control"><input id="durationMinuteOnes" class="digit" maxlength="1" inputmode="numeric" pattern="[0-9]*" /></div>
      </div>
    </div>
    <div class="inputs-group" id="cyclesInput" style="display:none;">
      <label for="numCycles">Number of washing cycles:</label>
      <div class="time-input" id="cyclesTimeInput">
        <div class="digit-control">
          <button type="button" class="digit-btn" id="numCyclesUp">â–²</button>
          <input id="numCycles" class="digit number-input" maxlength="2" inputmode="numeric" value="1" pattern="[0-9]*" />
          <button type="button" class="digit-btn" id="numCyclesDown">â–¼</button>
        </div>
      </div>
    </div>
    <div class="button-row">
      <button type="button" id="calcBtn" class="main-btn">ðŸ§® Calculate</button>
      <button type="button" id="predictBtn" class="main-btn">ðŸ”† Predict Best Start Times</button>
      <button type="reset" id="resetBtn" class="main-btn">ðŸ”„ Reset</button>
    </div>
  </form>
  <div id="result" aria-live="polite"></div>
</div>
</body>
</html>
